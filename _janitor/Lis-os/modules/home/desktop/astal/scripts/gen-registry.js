const { readdirSync, writeFileSync } = require('fs');
const { join, basename } = require('path');

// CONFIGURE PATHS
const WIDGETS_DIR = './widgets';
const REGISTRY_FILE = './src/registry.ts';

console.log(`üîç Scanning ${WIDGETS_DIR} for widgets...`);

try {
    // 1. Scan Directory
    const files = readdirSync(WIDGETS_DIR)
        .filter(f => f.endsWith('.tsx') || f.endsWith('.ts'));

    if (files.length === 0) {
        console.warn("‚ö†Ô∏è  No widgets found in " + WIDGETS_DIR);
    }

    // 2. Generate Imports & Map Entries
    const imports = [];
    const mapEntries = [];

    files.forEach(f => {
        const name = basename(f, '.tsx').replace('.ts', '');
        const importName = name;

        // Construct Import
        imports.push(`import ${importName} from '../widgets/${name}';`);

        // Construct Map Entry ("clock": Clock)
        // Normalize key: remove "Widget" suffix, lowercase
        const key = name.toLowerCase().replace(/widget$/, '');
        mapEntries.push(`    "${key}": ${importName},`);
    });

    // 3. Generate File Content
    const content = `// AUTO-GENERATED FILE - DO NOT EDIT
// Generated by scripts/gen-registry.js
// Definition of the "Bundle Reality" - All available widgets.

${imports.join('\n')}

export const WIDGET_MAP = {
${mapEntries.join('\n')}
} as const;

export type WidgetId = keyof typeof WIDGET_MAP;

export default WIDGET_MAP;
`;

    // 4. Write to Disk
    writeFileSync(REGISTRY_FILE, content);
    console.log(`‚úÖ Generated registry.ts with ${files.length} widgets.`);

} catch (error) {
    console.error("‚ùå Failed to generate registry:", error);
    process.exit(1);
}
